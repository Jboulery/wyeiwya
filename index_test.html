<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<script src="d3/d3.min.js"></script>
	<title>Projet DataVis WYEIWYA</title>
</head>
<body>
	<h3>Hello World !</h3>
	<div id="scatterplot"></div>
	<script type="text/javascript">
			
		// Inspirated by : 
		// http://bl.ocks.org/mbostock/3943967
		// https://bl.ocks.org/mbostock/1256572

		var margin = {top: 20, right: 20, bottom: 30, left: 40};
		var width = 960 - margin.left - margin.right;
		var height = 500 - margin.top - margin.bottom;

		// Create svg canvas

		var svg = d3.select("#scatterplot")
		.append("svg")
		.attr("width",width+margin.left+margin.right)
		.attr("height",height+margin.bottom+margin.top)

		var g = svg.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
		
		// Data parameters :
		x_coord = "sugars_100g";
		y_coord = "fat_100g";
		
		//**************************//
		//		Data processing		//
		//**************************//		
		
		d3.csv("data/food_data.csv", function(error,data) {
				// Test
				if (error){console.log(error)}
				
				else{
					// Save data
					dataset = data;
					
					//******************************//
					//			Format data			//
					//******************************//
					
					data = data.filter(function(d) {
						// delete any absurd line
						ValuesPer100g = [+d.fat_100g,
										+d['saturated-fat_100g'],
										+d.cholesterol_100g,
										+d.carbohydrates_100g,
										+d.sugars_100g,
										+d.fiber_100g,
										+d.proteins_100g,
										+d.salt_100g,
										+d.sodium_100g,
										+d['vitamin-a_100g'],
										+d['vitamin-c_100g'],
										+d.calcium_100g,
										+d.iron_100g];
					
						return (d.code != "" && d.countries_tags != "") && (d3.max(ValuesPer100g) <= 100) && (d3.min(ValuesPer100g) >= 0);
					})
					
					// Duplicate products with two "coutry_tag"
					data.forEach(function(d){

						if (d.countries_tags.split(",").length>1){
							var tab = d.countries_tags.split(",") ;
							d.countries_tags = tab[0];
							for (var i=0;i<tab.length-1;i++){
								var element = d;
								element.countries_tags = tab[i+1];
								data.push(element);
								}
						}
					});

					// Nest data
					var ByCountry = d3.nest()
						.key(function(d) {return d.countries_tags})
						.entries(data);

					//console.log(ByCountry);
					
					//**************************//
					//			Data plot		//
					//**************************//
			
					// Extremums
					var Xmin = d3.min(data, function(d) {
												return +d[x_coord];});
					var Xmax = d3.max(data, function(d) {
												return +d[x_coord];});
					var Ymin = d3.min(data, function(d) {
												return +d[y_coord];});
					var Ymax = d3.max(data, function(d) {
												return +d[y_coord];});
					

					// Create scales
					var x = d3.scaleLinear()
						.domain([0,Xmax])
						.range([0,width]);
					var y = d3.scaleLinear()
						.domain([0,Ymax])
						.range([height,0]);
					
					// Create axis
					var xAxis = d3.axisBottom()
						.scale(x);
					
					var yAxis = d3.axisLeft()
						.scale(y);
						
					var gX = svg.append("g")
						.attr("class","axis")
						.attr("transform", "translate(" + margin.left + "," + (height+margin.top) + ")")
						.call(xAxis);
						
					var gY = svg.append("g")
						.attr("class", "axis")
						.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
						.call(yAxis);
					
								
					//**********************//
					//		Data plots		//
					//**********************//
				
					// Create and display dots
					var dots = g.selectAll(".country")	
						.data(ByCountry)
						.enter()
						.append("g")	// added new group
						.attr("class","country")
						
						// Change color
						//.attr("d", function(d){return colorScale(d.key);})
						.selectAll("path")
						.data(function(d){return d.values;})
						.enter()
						.append("path")
						.attr("class", "symbol")
						
						// Change symbol
						.attr("d", d3.symbol().type(d3.symbolCircle).size(20)())
						.attr('fill',"rgb(31,119,180)")
						
						// (x,y) coordinates
						.attr("transform",function(d) {return "translate(" + x(+d[x_coord]) +","+ y(+d[y_coord]) +")" ;})
	
			// End of Data processing
			}});
	</script>
</body>
</html>